<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–ú–∞–≥–∞–∑–∏–Ω</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-5">
    <h1 class="text-center mb-4">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à –º–∞–≥–∞–∑–∏–Ω!</h1>

    <!-- –í—ã–≤–æ–¥ —Ç–æ–≤–∞—Ä–æ–≤ -->
    <div class="row">
        {% for item in items %}
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title">{{ item.name }}</h5>
                    <p class="card-text">{{ item.description }}</p>
                    <p class="fw-bold">–¶–µ–Ω–∞: {{ item.price }} ‚ÇΩ</p>

                    <!-- –ö–Ω–æ–ø–∫–∞ "–í –∫–æ—Ä–∑–∏–Ω—É" -->
                    <button onclick="addToCart({{ item.id }})" class="btn btn-success">–í –∫–æ—Ä–∑–∏–Ω—É</button>

                    <!-- –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥—Ä–æ–±–Ω–µ–µ" -->
                    <a href="{% url 'item' item.id %}" class="btn btn-primary">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ "–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑" -->
    <div class="text-center mt-4">
        <button id="create-order" class="btn btn-warning btn-lg">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
    </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Stripe -->
<script src="https://js.stripe.com/v3/"></script>
<script>
    var stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}");

    // ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É
    function addToCart(itemId) {
        let cart = JSON.parse(localStorage.getItem("cart")) || [];  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
        if (!cart.includes(itemId)) {
            cart.push(itemId);  // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä
        }
        localStorage.setItem("cart", JSON.stringify(cart));  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
        alert("‚úÖ –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!");
        console.log("üõí –ö–æ—Ä–∑–∏–Ω–∞ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:", cart);
    }

    // ‚úÖ –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É
    document.getElementById("create-order").addEventListener("click", function () {
        let cart = JSON.parse(localStorage.getItem("cart")) || [];
        console.log("üì¶ –¢–µ–∫—É—â–∞—è –∫–æ—Ä–∑–∏–Ω–∞:", cart);

        if (cart.length === 0) {
            alert("üõí –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞! –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –ø–µ—Ä–µ–¥ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞.");
            return;
        }

        let url = `/create_order/?` + cart.map(id => `items=${id}`).join("&");
        console.log("üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞:", url);

        fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log("üîÑ –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data);
                if (!data.order_id) {
                    alert("‚ùå –û—à–∏–±–∫–∞: –∑–∞–∫–∞–∑ –Ω–µ —Å–æ–∑–¥–∞–Ω!");
                    return;
                }

                localStorage.removeItem("cart");  // –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É –ø–æ—Å–ª–µ –∑–∞–∫–∞–∑–∞
                console.log("üõí –ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞ –ø–æ—Å–ª–µ –∑–∞–∫–∞–∑–∞.");

                // –¢–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞–µ–º session_id –¥–ª—è –æ–ø–ª–∞—Ç—ã
                fetch(`/buy_order/${data.order_id}/`)
                    .then(response => response.json())
                    .then(session => {
                        if (!session.session_id) {
                            alert("‚ùå –û—à–∏–±–∫–∞: session_id –Ω–µ –ø–æ–ª—É—á–µ–Ω!");
                            return;
                        }
                        console.log("‚úÖ session_id –ø–æ–ª—É—á–µ–Ω:", session.session_id);
                        stripe.redirectToCheckout({ sessionId: session.session_id });
                    })
                    .catch(error => {
                        console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ session_id:", error);
                        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ!");
                    });

            })
            .catch(error => {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞:", error);
                alert("–û—à–∏–±–∫–∞! –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å.");
            });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
